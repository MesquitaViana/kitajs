// Required
import type { RouteContext, ProvidedRouteContext } from '@kitajs/runtime';
import fp from 'fastify-plugin';

// Addons
{{#each imports.addons}}
  {{this}}
{{/each}}

// Controllers
{{#each imports.controllers}}
  {{this}}
{{/each}}

// Param Resolvers
{{#each imports.params}}
  {{this}}
{{/each}}

/** The resultant config read from your kita config file. */
export const KitaConfig = {{json config}};

/** The fastify plugin to be registered. */
export const Kita = fp<{ context: ProvidedRouteContext }>((fastify, options) => {
  const context: RouteContext = { ...options.context, config: KitaConfig, fastify };

  {{#each schemas}}
    fastify.addSchema({{json this}});

  {{/each}}

  {{#each routes}} 
    fastify.route({
      method: {{#if (isAllMethod method)}}['DELETE', 'GET', 'HEAD', 'PATCH', 'POST', 'PUT', 'OPTIONS']{{else}}'{{uppercase method}}'{{/if}},
      url: '{{path}}',
      schema: {{json schema}},
      handler: async (request, reply) => {
        {{#each parameters}}
          {{#if helper}}
            {{helper}}

            if (reply.sent) {
              return;
            }

          {{/if}}
        {{/each}}

        const data = await {{controllerName}}.{{method}}.apply(context, [{{paramsToString parameters}}]);
        
        if (reply.sent) {
          //@ts-ignore - Possible "An expression of type 'void' cannot be tested for truthiness. ts(1345)"
          if (data) {
            const error = new Error('Reply already sent, but controller returned data');
            //@ts-expect-error - TODO: generate better error message
            error.data = data;
            throw error;
          }

          return;
        }

        return data;
      },
      {{options}}
    });
    
  {{/each}}

  // Ensure this function remains a "async" function
  return Promise.resolve();
});

export const HBS_CONF = {{json this}};
