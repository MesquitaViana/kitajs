import type { RouteContext, ProvidedRouteContext } from '@kitajs/runtime';
import fp from 'fastify-plugin';
import '@fastify/swagger';
{{#each imports}}
  {{this}}
{{/each}}

/** The resultant config read from your kita config file. */
export const KitaConfig = {{json config}};

/** The fastify plugin to be registered. */
export const Kita = fp<{ context: ProvidedRouteContext }>((fastify, options) => {
  const context: RouteContext = { config: KitaConfig, fastify, ...options.context };

  {{#each schemas}}
    fastify.addSchema({{jsonf this}});

  {{/each}}

  {{#each routes}} 
    {{route.template}}
  {{/each}}

  // Ensure this function remains a "async" function
  return Promise.resolve();
});

/** Internal helpers to this template */
export const Helpers = {
  replyAlreadySent(data: any) {
    const error = new Error('Reply already sent, but controller returned data');
    
    //@ts-expect-error - include data in error to help debugging
    error.data = data;
    
    return error;
  }
}

/** Handlebars data for hydration, just for debugging purposes. */
export const HBS_CONF = {{json this}};
